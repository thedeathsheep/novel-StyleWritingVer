# StyleEvent（风格写作）产品需求与指标

面向「灵感共鸣式写作」的**产品需求与可度量指标**文档，用于对齐产品、设计与开发。  
本文档落实《Echo-技术架构评估与改进建议》中的建议项。

---

## 一、产品定位与核心价值（简述）

- **产品名**：StyleEvent（风格写作）
- **定位**：面向写作者的「知识锚点式」灵感共鸣引擎；不代写、只检索，有据可查。
- **核心价值**：随用户写作，从配置的知识库中**语义检索**出相关片段，在**中间偏上的灵感区**以纯文本（正式文本 + 小字出处）静默呈现，激发灵感而非替代写作。

---

## 二、表现目标（必达指标）

以下目标写入产品需求，作为验收与架构选型依据。

| 指标 | 目标值 | 说明 |
|------|--------|------|
| **延迟** | 触发 → 灵感区首条可见：**P95 &lt; 800ms** | MVP 阶段可放宽至 **P95 &lt; 1.2s**，后续优化到 800ms 内。 |
| **出处准确性** | **100%** | 每条灵感必须来自真实入库片段，带可追溯来源（库名 + 可选书名/章节）；禁止模型编造出处。 |
| **相关性** | 前 3 条中至少 1 条「有用」：目标 **&gt; 60%**（通过问卷或埋点收集） | 定义「有用」：用户点击、复制或标记为有帮助。 |

---

## 三、检索与数据要求

### 3.1 检索分层（按阶段）

| 阶段 | 检索方式 | 说明 |
|------|----------|------|
| **MVP** | 单路向量检索，top-K = 5～8 | 当前句/词 embedding → 向量库检索 → 按相似度取 top-K，不做 rerank。 |
| **V1.5** | 向量 + 稀疏（BM25）→ 合并 → **rerank** 取 top-3～5 | 提高意象、专有名词、古文的召回与排序；rerank 模型可选 BGE reranker、Cohere 等。 |

### 3.2 分块策略 (Chunking)

- **粒度**：以**句或短段**为单位，避免跨句破碎。
- **重叠**：允许少量重叠（如相邻句带 1 句重叠），保证语义完整。
- **元数据**：每块必带：来源库 ID、书名/章节（若有）、原始文本片段。

### 3.3 多库与权重

- **多库**：支持用户同时启用多个「风味库」；每个库独立建索引，检索时**按库权重合并**结果。
- **权重**：每个库有 0～1 的权重；合并时按权重加权得分或按权重分配条数（如 60% 古代史 + 40% 物理百科 → 前 3 条中约 2 条古代史、1 条物理）。
- **MVP**：可先支持单库或固定 2～3 库；V1.5 再支持用户自定义多库与权重。

### 3.4 缓存与节流

- **缓存**：对「查询文本或 query embedding」做短期缓存（如最近 50 条，TTL 5 分钟），相同/极相似请求直接返回缓存，降低延迟与成本。
- **节流**：前端触发条件已定（停顿 1.5s 或选中）；同一触发下若上一次请求未返回，可**取消上一次请求**，只保留最新一次。

---

## 四、可观测与降级

### 4.1 监控指标（建议）

- 检索**延迟**：P50 / P95 / P99（从收到请求到返回结果）。
- **空结果率**：返回 0 条的请求占比。
- **错误率**：超时、5xx、embedding/向量库异常占比。
- **出处校验**：抽检返回结果的出处是否均能在库中查到（可选自动化）。

### 4.2 降级与边界行为

| 场景 | 行为 | 说明 |
|------|------|------|
| **检索超时** | 超时阈值 **2s**；超时后返回空列表，灵感区保持上一状态或显示「暂无灵感」。 | 不阻塞编辑，不报错弹窗。 |
| **空结果** | 返回空数组；灵感区显示「未找到相关片段」或保持空状态文案。 | 不编造内容。 |
| **部分库失败** | 仅用成功返回的库的结果合并；若全失败则同「超时」。 | 记录失败库与原因，便于排查。 |
| **请求被取消** | 前端取消时忽略该次响应，不更新灵感区。 | 避免旧请求覆盖新结果。 |

---

## 五、隐私与部署分工

### 5.1 端 / 云分工（建议）

| 环节 | 推荐部署 | 说明 |
|------|----------|------|
| **编辑器与灵感区** | 前端（浏览器） | 编辑器 + 中间偏上灵感区（纯文本）；触发、节流、取消逻辑在前端。 |
| **Query embedding** | 云端 或 本地可选 | MVP 用云端 API（如 OpenAI / 国内 embedding 接口）；V2 可选本地（BGE-small / m3e）满足隐私需求。 |
| **向量检索** | 云端 或 本地可选 | MVP 用云端向量库（Pinecone / pgvector 等）；V2 可选本地 LanceDB 做「仅本地知识库」模式。 |
| **知识库与索引** | 云端 或 用户本机 | 默认云端建索引；若支持「纯本地风味库」，则索引与检索均在用户环境。 |

### 5.2 隐私原则

- 用户当前书写内容仅用于**当次检索**，不落库、不用于训练。
- 用户上传的私有文档仅用于其个人知识库索引，不与他人共享。

---

## 六、阶段与里程碑（与架构对齐）

| 阶段 | 产品范围 | 表现目标 | 检索与数据 |
|------|----------|----------|------------|
| **MVP** | 单库/少量库、灵感区（中间偏上/瀑布流）、触发（停顿+选中） | P95 &lt; 1.2s、出处 100%、相关性可观测 | 单路向量、简单缓存、超时 2s 降级 |
| **V1.5** | 多库、权重、出处必显 | P95 &lt; 800ms、出处 100%、相关性 &gt; 60% | 混合检索 + rerank、多库合并、监控 P95 |
| **V2** | 本地/离线模式、隐私模式 | 同上，可选本地无上传 | 本地 embedding、本地向量库、可选查询扩展 |

---

## 七、与其它文档的关系

- **流程与交互**：见《Echo-灵感瀑布流-流程原型》—— 触发顺序、灵感区行为、F1～F4 原型。
- **界面与视觉**：见《FIGMA-原型设计说明》—— 主界面（极简暗色）、灵感区纯文本与出处。
- **技术选型与评估**：见《Echo-技术架构评估与改进建议》—— 向量库、Embedding、RAG 最佳实践与阶段建议。

上述**表现目标、检索分层、多库策略、降级与可观测、隐私与部署分工**均已纳入本文档，作为产品与开发的统一依据。
